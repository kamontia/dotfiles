# prefixをCtrl+aに変更（screenライク、小指が楽）
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# 番号を1始まりに
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# マウス有効
set -g mouse on

# マウスホイールのスクロール量を調整（3行ずつ）
bind -T copy-mode-vi WheelUpPane select-pane \; send -X -N 3 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send -X -N 3 scroll-down
bind -n WheelUpPane if-shell -F "#{mouse_any_flag}" "send -M" "if -Ft= '#{pane_in_mode}' 'send -M' 'copy-mode -e; send -X -N 3 scroll-up'"

# ヒストリ増やす
set -g history-limit 50000

# 256色 + True Color（Ghostty対応）
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",*:RGB"
set -ag terminal-overrides ",*:Ms=\\E]52;%p1%s;%p2%s\\007"

# ESCの遅延をなくす（Vim/Claude Code対策）
set -sg escape-time 0

# ウィンドウ名を自動リネーム
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# ペイン分割（pain-controlが担当するため最小限に）
bind c new-window -c "#{pane_current_path}"

# ペイン同期トグル（複数Claude Codeへの一括操作）
bind S setw synchronize-panes \; display "Sync: #{?pane_synchronized,ON,OFF}"

# ウィンドウ高速切り替え（Option+矢印）
bind -n M-Left previous-window
bind -n M-Right next-window

# コピーモードをvi風に
setw -g mode-keys vi
bind v copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel

# 設定リロード
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# ステータスバー更新間隔
set -g status-interval 5

# セッション切り替え時にステータスバーを即時更新
set-hook -g client-session-changed 'refresh-client -S'

# ===== プラグイン設定 =====

# resurrect: Claudeプロセスも復元
set -g @resurrect-processes 'claude ssh'
set -g @resurrect-capture-pane-contents 'on'

# continuum: 15分ごとに自動保存
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# yank: マウス選択で自動クリップボードコピー
set -g @yank_selection_mouse 'clipboard'

# sessionx
set -g @sessionx-bind 'o'
set -g @sessionx-preview-enabled 'true'
set -g @sessionx-filter-current 'false'

# ===== catppuccin（公式ドキュメント通りの順序） =====
# 1. catppuccin のオプションを設定
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_date_time_text "%Y-%m-%d %H:%M"
# CPUモジュール
set -g @catppuccin_cpu_text " #{l:#{cpu_percentage}}"

# 2. catppuccin を先にロード
run '~/.tmux/plugins/tmux/catppuccin.tmux'

# 3. status-right を設定
set -g status-right-length 100
set -g status-left-length 100
set -g status-left "#[fg=#{@thm_green},bg=default]#[fg=#{@thm_crust},bg=#{@thm_green}] 󰖲 #[fg=#{@thm_green},bg=#{@thm_surface_0}]#[fg=#{@thm_fg},bg=#{@thm_surface_0}] #S #[fg=#{@thm_surface_0},bg=default]"
set -gF status-right "#{E:@catppuccin_status_cpu}"
set -agF status-right "#{E:@catppuccin_status_battery}"
set -agF status-right "#{E:@catppuccin_status_date_time}"

# 4. TPM でその他プラグインをロード（cpu/battery もここで処理される）
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-fingers'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-online-status'
set -g @plugin 'tmux-plugins/tmux-notify'

run '~/.tmux/plugins/tpm/tpm'
